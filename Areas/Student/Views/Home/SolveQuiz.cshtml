@model TadrousManassa.Areas.Student.Models.SolveQuizVM
@{
    ViewData["Title"] = "Solve Quiz";
    var totalSeconds = (Model.TimeHours * 60 + Model.TimeMinutes) * 60;
}

<!-- Timer -->
<div id="quiz-timer" class="alert alert-warning text-center fw-bold fs-4" style="margin-bottom:0;">
    Remaining Time: <span id="timer"></span>
</div>

<div class="container mt-4 mb-5">
    <h2 class="text-center mb-4">@Model.QuizName</h2>

    <form id="quizForm" method="post">
        <input type="hidden" name="QuizId" value="@Model.QuizId" />
        <div id="questions-container">
            <!-- Questions will be loaded here by JavaScript -->
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading questions...</p>
            </div>
        </div>
        <div class="text-center mt-4" id="submit-section" style="display: none;">
            <button type="button" id="submitBtn" class="btn btn-success btn-lg px-5">Submit</button>
        </div>
    </form>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // --- Get data from server with debugging ---
        const questionsData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Questions));
        const totalSeconds = @totalSeconds;
        const quizStartTime = @Html.Raw(Json.Serialize(ViewBag.QuizStartTime ?? DateTime.Now));
        let timerInterval;
        let timeLeft = totalSeconds;

        // Debug the received data
        console.log('Raw questionsData:', questionsData);
        console.log('Total questions received:', questionsData ? questionsData.length : 'No data');
        console.log('Total seconds for quiz:', totalSeconds);

        // --- Shuffle function ---
        function shuffle(array) {
            const shuffled = [...array]; // Create a copy first
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // --- Display questions and choices with random order ---
        function renderQuestions() {
            console.log('Starting renderQuestions function...');
            const container = document.getElementById('questions-container');

            if (!container) {
                console.error('Questions container not found!');
                return;
            }

            // Clear loading content
            container.innerHTML = '';

            // Check if we have questions data
            if (!questionsData) {
                console.error('No questions data received');
                container.innerHTML = '<div class="alert alert-danger text-center">No questions data received from server</div>';
                return;
            }

            if (!Array.isArray(questionsData) || questionsData.length === 0) {
                console.error('Questions data is empty or not an array');
                container.innerHTML = '<div class="alert alert-warning text-center">No questions available for this quiz</div>';
                return;
            }

            console.log(`Rendering ${questionsData.length} questions...`);

            try {
                // Shuffle questions for random order
                const shuffledQuestions = shuffle(questionsData);

                shuffledQuestions.forEach((question, index) => {
                    console.log(`Processing question ${index + 1}:`, question);

                    const questionId = question.Id;
                    const questionText = question.Text;
                    const questionImage = question.Image;
                    const questionChoices = question.Choices;


                    if (!questionId) {
                        console.error(`Question ${index + 1} missing ID:`, question);
                        return;
                    }

                    if (!questionText) {
                        console.error(`Question ${index + 1} missing text:`, question);
                        return;
                    }

                    if (!questionChoices || !Array.isArray(questionChoices) || questionChoices.length === 0) {
                        console.error(`Question ${index + 1} has no choices:`, question);
                        return;
                    }

                    // Shuffle choices for random order
                    const shuffledChoices = shuffle(questionChoices);

                    // Build question HTML
                    let questionHtml = `<div class='card mb-4 question-block' id='question-block-${questionId}'>`;
                    questionHtml += `<div class='card-header fw-bold'>Question ${index + 1}:</div>`;
                    questionHtml += `<div class='card-body'>`;
                    questionHtml += `<p class='fs-5 mb-3'>${questionText}</p>`;

                    // Add image if exists
                    if (questionImage) {
                        questionHtml += `<img src='${questionImage}' alt='Question Image' class='img-fluid mb-3' style='max-width:300px;' />`;
                    }

                    questionHtml += `<div class='choices-list'>`;

                    // Add choices
                    shuffledChoices.forEach(choice => {
                        const choiceId = choice.id || choice.Id;
                        const choiceText = choice.text || choice.Text;
                        const choiceImage = choice.image || choice.Image;

                        if (!choiceId) {
                            console.error('Choice missing ID:', choice);
                            return;
                        }

                        questionHtml += `<div class='form-check mb-2 choice-row' data-choice-id='${choiceId}' data-question-id='${questionId}'>`;
                        questionHtml += `<input class='form-check-input' type='radio' name='answers[${questionId}]' id='choice-${choiceId}' value='${choiceId}'>`;
                        questionHtml += `<label class='form-check-label' for='choice-${choiceId}'>`;

                        if (choiceText) {
                            questionHtml += choiceText;
                        }

                        if (choiceImage) {
                            questionHtml += `<br><img src='${choiceImage}' alt='Choice Image' class='img-fluid mt-2' style='max-width:200px;' />`;
                        }

                        questionHtml += `</label></div>`;
                    });

                    questionHtml += `</div></div></div>`;

                    // Add to container
                    container.innerHTML += questionHtml;
                });

                console.log('Questions rendered successfully');

                // Show submit button
                document.getElementById('submit-section').style.display = 'block';

                // Add click event listeners to choice rows
                addChoiceClickListeners();

            } catch (error) {
                console.error('Error rendering questions:', error);
                container.innerHTML = '<div class="alert alert-danger text-center">Error displaying questions. Please refresh the page.</div>';
            }
        }

        // --- Add click listeners to choice rows ---
        function addChoiceClickListeners() {
            const choiceRows = document.querySelectorAll('.choice-row');
            choiceRows.forEach(row => {
                row.addEventListener('click', function(e) {
                    // Prevent double triggering if user clicks directly on radio button or label
                    if (e.target.type === 'radio' || e.target.tagName === 'LABEL') {
                        return;
                    }

                    const choiceId = this.getAttribute('data-choice-id');
                    const radioButton = document.getElementById(`choice-${choiceId}`);

                    if (radioButton) {
                        radioButton.checked = true;
                        // Trigger change event for any other listeners
                        radioButton.dispatchEvent(new Event('change'));
                    }
                });

                // Add cursor pointer to indicate clickability
                row.style.cursor = 'pointer';
            });
        }

        // --- Calculate remaining time based on start time ---
        function calculateRemainingTime() {
            const now = new Date();
            const startTime = new Date(quizStartTime);
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            const remaining = totalSeconds - elapsedSeconds;

            console.log('Quiz start time:', startTime);
            console.log('Current time:', now);
            console.log('Elapsed seconds:', elapsedSeconds);
            console.log('Remaining seconds:', remaining);

            return Math.max(0, remaining);
        }

        // --- Timer functions ---
        function startTimer() {
            // Calculate remaining time based on quiz start time
            timeLeft = calculateRemainingTime();

            if (timeLeft <= 0) {
                console.log('Quiz time has already expired');
                autoSubmitQuiz();
                return;
            }

            console.log(`Starting timer with ${timeLeft} seconds remaining`);
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                timeLeft = calculateRemainingTime();
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    autoSubmitQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.textContent = `${minutes} minutes ${seconds < 10 ? '0' : ''}${seconds} seconds`;
            }
        }

        // --- Check if all questions are answered ---
        function getUnansweredQuestionId() {
            if (!questionsData || !Array.isArray(questionsData)) {
                return null;
            }

            for (const question of questionsData) {
                const questionId = question.Id;
                const radios = document.getElementsByName(`answers[${questionId}]`);
                let answered = false;

                for (const radio of radios) {
                    if (radio.checked) {
                        answered = true;
                        break;
                    }
                }

                if (!answered) {
                    return questionId;
                }
            }
            return null;
        }

        // --- Submit quiz ---
        function submitQuiz() {
            console.log('Submit button clicked');

            const unansweredId = getUnansweredQuestionId();
            if (unansweredId) {
                // Scroll to unanswered question
                const questionBlock = document.getElementById(`question-block-${unansweredId}`);
                if (questionBlock) {
                    questionBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                Swal.fire({
                    icon: 'warning',
                    title: 'Please solve all questions before submitting',
                    confirmButtonText: 'Okay'
                });
                return;
            }

            Swal.fire({
                title: 'Confirm Submitting',
                text: 'You will not be able to change your solutions after submitting. Are you sure?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, submit now',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    sendQuizForm();
                }
            });
        }

        // --- Actually send the form ---
        function sendQuizForm() {
            console.log('Sending quiz form...');
            clearInterval(timerInterval);

            const form = document.getElementById('quizForm');
            if (!form) {
                console.error('Quiz form not found');
                return;
            }

            const formData = new FormData(form);

            // Show loading
            Swal.fire({
                title: 'Submitting...',
                text: 'Please wait while we process your answers',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch('@Url.Action("SolveQuiz", "Home")', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                if (data.success) {
                    console.log('Quiz submitted successfully, redirecting...');
                    // using the sended url from the server
                    window.location.href = data.redirectUrl;
                } else {
                    throw new Error(data.message || 'Submission failed');
                }

            })
            .catch(error => {
                console.error('Error submitting quiz:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Submission Error',
                    text: error.message || 'There was an error submitting your quiz. Please try again.'
                });
            });
        }

        // --- Auto submit when time runs out ---
        function autoSubmitQuiz() {
            console.log('Time up - auto submitting...');

            Swal.fire({
                icon: 'info',
                title: 'Time Out!',
                text: 'Your solutions have been submitted automatically',
                showConfirmButton: false,
                timer: 2000
            });

            setTimeout(() => {
                sendQuizForm();
            }, 2000);
        }

        // --- Initialize page ---
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing quiz...');

            // Render questions first
            renderQuestions();

            // Start timer
            startTimer();

            // Add submit button event listener
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', submitQuiz);
            } else {
                console.error('Submit button not found');
            }

            console.log('Quiz initialization complete');
        });
    </script>
}